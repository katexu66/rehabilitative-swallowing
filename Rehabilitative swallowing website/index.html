<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="/static/style.css" /> <!-- static url -->
        <title>Rehabilitative Swallowing</title>
    </head>
    <body>
        <h1>throat workout üèãÔ∏è</h1>

    <!-- <button id="btn-raw" class="button">raw data</button>
    <button id="btn-env" class="button">envelope</button> -->
    <button class="button">stats</button>
    <button class="button">game</button>
    <!-- <a class="button" href="/static/login.html">log in to view data</a> static -->
    <a class="button" href="/static/data.html">view previous sessions</a> <!-- static -->
    <br>
    <button id="btn-stream" class="button special">start stream</button>
    <button id="btn-stopstream" class="button special">stop stream</button>
    <div id="timer" style="display: none">Stream started! Time elapsed: <span id="time"></span></div>
    <div id="finished" style="display: none">Session recorded! Time elapsed: <span id="finishedtime"></span>. Would you like to save this session?
        <button id="save">yes</button> <button id="discard">no</button>
    </div>
    <div id="saveStatus" style="margin-top:6px; font-family: system-ui;"></div>
    <hr>

    <!-- container for plot -->
    <p>Raw data</p>
    <canvas id="plot-raw" width="900" height="350" style="border:1px solid #ddd; max-width: 100%;"></canvas>
    <p>Envelope</p>
    <canvas id="plot-env" width="900" height="350" style="border:1px solid #ddd; max-width: 100%;"></canvas>
    <div id="status" style="margin-top:8px; font-family: system-ui;">Status: disconnected</div>

    <br>
    <div id="footer"><hr>
    <p>MIT</p></div>

    <!-- script to connect to app -->
    <script>
      const btnStream = document.getElementById("btn-stream");
      const btnStopStream = document.getElementById("btn-stopstream");
      const saveStatusEl = document.getElementById("saveStatus");
      const statusEl = document.getElementById("status");
      const canvas_raw = document.getElementById("plot-raw");
      const ctx_raw = canvas_raw.getContext("2d");
      const canvas_env = document.getElementById("plot-env");
      const ctx_env = canvas_env.getContext("2d");

      let ws = null;
      let session_id = null;
      let fs = 200;
      let nCh = 4;

      // simple ring buffer for channel 0
      const seconds = 5;
      let buf_raw = [];
      let buf_env = [];
      let maxLen = seconds * fs;

      function draw(buf, ctx, canvas) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (buf.length < 2) return;

        // autoscale
        let min = Infinity, max = -Infinity;
        for (const v of buf) { if (v < min) min = v; if (v > max) max = v; }
        if (min === max) { min -= 1; max += 1; }

        const w = canvas.width, h = canvas.height;
        ctx.beginPath();
        for (let i = 0; i < buf.length; i++) {
          const x = (i / (buf.length - 1)) * w;
          const y = h - ((buf[i] - min) / (max - min)) * h;
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        ctx.stroke();
      }

      function connect() {
        const wsProto = location.protocol === "https:" ? "wss" : "ws";
        ws = new WebSocket(`${wsProto}://${location.host}/ws`);
        // ws = new WebSocket("ws://127.0.0.1:8000/ws"); // hard coded this
        statusEl.textContent = "Status: connecting...";

        ws.onopen = () => statusEl.textContent = "Status: connected";
        ws.onclose = () => {
            statusEl.textContent = "Status: disconnected";
            document.getElementById("finished").style.display = "block";
        }
        ws.onerror = () => statusEl.textContent = "Status: error";

        document.getElementById("timer").style.display = 'block';
        starttimer();

        session_id = null;

        ws.onmessage = (ev) => {
          const msg = JSON.parse(ev.data);

          if (msg.type === "meta") {
            fs = msg.fs;
            nCh = msg.channels;
            maxLen = seconds * fs;
            buf_raw = []; // clear buffers
            buf_env = [];
            session_id = msg.session_id;
            return;
          }

          if (msg.type === "data") {
            for (const row of msg.raw) buf_raw.push(row[0]);
            for (const row of msg.env) buf_env.push(row[0]);

            if (buf_raw.length > maxLen) buf_raw = buf_raw.slice(-maxLen);
            if (buf_env.length > maxLen) buf_env = buf_env.slice(-maxLen);

            draw(buf_raw, ctx_raw, canvas_raw);
            draw(buf_env, ctx_env, canvas_env);
          }
        };
      }

    //   streaming buttons
      btnStream.onclick = () => {
        saveStatusEl.textContent = "";
        document.getElementById("save").disabled = false;
        document.getElementById("discard").disabled = false;
        document.getElementById("finished").style.display = 'none';
        if (!ws || ws.readyState !== WebSocket.OPEN) connect();
      };
      btnStopStream.onclick = () => {
        if (ws && ws.readyState === WebSocket.OPEN) {
            document.getElementById("timer").style.display = 'none';
            stoptimer();
            // document.getElementById("finished").style.display = 'block';
            ws.close();
        }
      }

    //   data save buttons

      document.getElementById("save").onclick = () => {
        if (!session_id) return;

        fetch(`/save/${session_id}`, { method: "POST" })
            .then(r => r.json())
            .then(res => {
                if (res.ok) saveStatusEl.textContent = "Session saved to data folder!";
                else saveStatusEl.textContent = "Save failed";
            });

        document.getElementById("save").disabled = true;
        document.getElementById("discard").disabled = true;
      }
      document.getElementById("discard").onclick = () => {
        if (!session_id) return;

        fetch(`/discard/${session_id}`, { method: "POST" })
            .then(r => r.json())
            .then(res => {
                if (res.ok) saveStatusEl.textContent = "Session discarded";
                else saveStatusEl.textContent = "Discard failed";
            });

        document.getElementById("save").disabled = true;
        document.getElementById("discard").disabled = true;

      }

    </script>

    <!-- script for timer -->
    <script>

        var secondsElapsed = 0;
        var minutes = 0;
        var timer;

        function tick() {
            secondsElapsed++;
            timeElapsed = minutes + ":0" + secondsElapsed;

            if (secondsElapsed > 9) {
                if (secondsElapsed % 60 == 0) {
                    secondsElapsed = 0;
                    minutes ++;
                    timeElapsed = minutes + ":00";
                }
                else {
                    timeElapsed = minutes + ":" + secondsElapsed;
                }
            }

            document.getElementById("time").innerText = timeElapsed;
        }

        function starttimer() {
            secondsElapsed = 0; // get rid of this if you just want it to "pause" instead of resetting at 0
            minutes = 0;
            document.getElementById("time").innerText = "0:00";
            timer = setInterval(tick, 1000); // call tick() function every 1 second
        }

        function stoptimer() {
            document.getElementById("finishedtime").innerText = timeElapsed;
            clearInterval(timer);
        }

    </script>

    </body>
</html>
