<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="/static/style.css" /> <!-- static url -->
        <title>Rehabilitative Swallowing</title>
    </head>
    <body>
        <h1>throat workout üèãÔ∏è</h1>

    <a href="/" style="text-decoration: underline;">return to home</a>
    <br>
    <label for="sessions">Select the session you would like to view:</label>
    <select name="sessions" id="sessions"></select>
    <button id="loadBtn">load</button>
    <hr>

    <!-- container for plot -->
    <p>Raw data</p>
    <canvas id="plot-raw" width="900" height="350" style="border:1px solid #ddd; max-width: 100%;"></canvas>
    <p>Envelope</p>
    <canvas id="plot-env" width="900" height="350" style="border:1px solid #ddd; max-width: 100%;"></canvas>
    <div id="status" style="margin-top:8px; font-family: system-ui;">Status: disconnected</div>

    <br>
    <div id="footer"><hr>
    <p>MIT</p></div>

    <script>
      const sel = document.getElementById("sessions");
      const loadBtn = document.getElementById("loadBtn");

      const canvas_raw = document.getElementById("plot-raw");
      const ctx_raw = canvas_raw.getContext("2d");
      const canvas_env = document.getElementById("plot-env");
      const ctx_env = canvas_env.getContext("2d");

      let ws = null;
      let session_id = null;

      function draw(buf, ctx, canvas) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (buf.length < 2) return;

        // autoscale
        let min = Infinity, max = -Infinity;
        for (const v of buf) { if (v < min) min = v; if (v > max) max = v; }
        if (min === max) { min -= 1; max += 1; }

        const w = canvas.width, h = canvas.height;
        ctx.beginPath();
        for (let i = 0; i < buf.length; i++) {
          const x = (i / (buf.length - 1)) * w;
          const y = h - ((buf[i] - min) / (max - min)) * h;
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        ctx.stroke();
      }

      async function refreshList() {
        const r = await fetch("/sessions");
        const { sessions } = await r.json();
        sel.innerHTML = sessions.map(id => `<option value="${id}">${id}</option>`).join("");
      }

      loadBtn.onclick = async () => {
        const id = sel.value;
        const r = await fetch(`/session/${id}?decim=5`); // adjust decim
        const msg = await r.json();

        // msg.raw and msg.env are [ [ch0,ch1,...], ... ] row-major
        const raw0 = msg.raw.map(row => row[0]); // channel 0
        const env0 = msg.env.map(row => row[0]);
        draw(raw0, ctxRaw, canvasRaw);
        draw(env0, ctxEnv, canvasEnv);
      };

      refreshList();
    </script>

    </body>
</html>
